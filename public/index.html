<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Get Plump Booking Widget</title>
  <style>
    /* —— Reset & Base —— */
    * { margin:0; padding:0; box-sizing:border-box }
    body { font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;
      background:#f5f5f7; display:flex; align-items:center; justify-content:center;
      height:100vh; }
    .widget { width:100%; max-width:600px; background:#fff; border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.1); display:flex; flex-direction:column;
      height:90vh; overflow:hidden; }
    .header { padding:16px; text-align:center; border-bottom:1px solid #e5e5e7; }
    .header h1 { font-size:1.25rem; color:#1d1d1f; }
    #messages { flex:1; overflow-y:auto; padding:16px; }
    .msg { margin-bottom:16px; display:flex; }
    .msg.system { justify-content:flex-start; }
    .msg.user   { justify-content:flex-end;   }
    .bubble { max-width:75%; padding:12px 16px; border-radius:16px; line-height:1.4; }
    .msg.system .bubble { background:#e9e9eb; color:#1d1d1f; border-bottom-left-radius:4px; }
    .msg.user   .bubble { background:#007AFF; color:#fff; border-bottom-right-radius:4px; }
    button { cursor:pointer; border:none; }
    .grid { display:grid; gap:12px; margin-top:8px; }
    .button { background:#fff; border:2px solid #e5e5e7; padding:12px;
      border-radius:12px; text-align:center; font-weight:500; transition:all .2s; }
    .button:hover { border-color:#007AFF; transform:translateY(-2px); }
    .primary { background:#007AFF; color:#fff; padding:12px 20px; border-radius:12px; }
    .primary:hover { background:#0056d6; }
    .input { width:100%; padding:10px; margin-bottom:8px;
      border:2px solid #e5e5e7; border-radius:8px; font-size:1rem; }
  </style>
</head>
<body>
  <div class="widget">
    <div class="header"><h1>Book Your Plump Appointment</h1></div>
    <div id="messages"></div>
  </div>

  <script>
  // —— Configuration —— 
  const BOULEVARD_API = '/api/blvd';
  const LOCATIONS = {
    'West Village':'ffaaff3c-d5ba-408e-ba3b-455554b77116',
    SoHo:'89763e68-2454-429c-ae9c-c1b4d91e7b81',
    Tribeca:'43dfb866-a872-4f01-9491-6c6584e3c3e7',
    Miami:'1cbb848e-138b-4142-bc3d-b9f4ea9a42db'
  };
  const STAFF = [
    { id:'s1', name:'Dr Sarah Johnson', locations:['West Village','SoHo'] },
    { id:'s2', name:'Dr Alex Kim',       locations:['Tribeca','Miami']   },
    { id:'s3', name:'Dr Maria Chen',     locations:['SoHo','Tribeca']   }
  ];

  // —— State ——
  let state = {
    flow:null,          // 'A'|'B'|'C'
    location:null,
    treatment:null,     // 'injectable'|'skincare'
    serviceId:null, serviceName:null,
    staffId:null,   staffName:null,
    cartId:null,
    timeSlot:{ id:null, label:null, location:null },
    client:{ firstName:'', lastName:'', email:'', phone:'' },
    // For Flow C:
    staffAvailabilityData:{}  // { 'YYYY-MM-DD': [ {id, startTime, locationName}, … ] }
  };
  let currentCalendarDate = null;

  // —— GraphQL helper ——
  function gql(query, variables={}) {
    return fetch(BOULEVARD_API, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ query, variables })
    }).then(r=>r.json());
  }

  // —— UI helpers ——
  function addMessage(who, html, cb) {
    const m = document.createElement('div');
    m.className = 'msg ' + who;
    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = html;
    m.appendChild(b);
    document.getElementById('messages').appendChild(m);
    m.scrollIntoView({ behavior:'smooth' });
    if (cb) setTimeout(cb, 400);
  }
  function makeButton(text, onClick, cls='button') {
    const btn = document.createElement('button');
    btn.className = cls;
    btn.textContent = text;
    btn.onclick = onClick;
    return btn;
  }

  // —— Flows Entry ——
  function start() {
    addMessage('system','Welcome! Choose how to book:', ()=>{
      const grid = document.createElement('div'); grid.className='grid';
      grid.appendChild(makeButton('A) By Location ▶︎ Category ▶︎…', ()=>{ state.flow='A'; flowA_start(); }));
      grid.appendChild(makeButton('B) By Staff ▶︎ Quick Time ▶︎…', ()=>{ state.flow='B'; flowB_start(); }));
      grid.appendChild(makeButton('C) Staff Availability ▶︎ Calendar ▶︎…', ()=>{ state.flow='C'; flowC_start(); }));
      addMessage('system', grid.outerHTML);
    });
  }

  // —— FLOW A —— Location → Treatment → Service → First/Staff → Info → Booking
  function flowA_start() {
    addMessage('system','Select location:', ()=>{
      const g=document.createElement('div'); g.className='grid';
      for (let loc in LOCATIONS) {
        g.appendChild(makeButton(loc, ()=>{
          state.location=loc; addMessage('user',loc, flowA_chooseTreatment);
        }));
      }
      addMessage('system',g.outerHTML);
    });
  }
  function flowA_chooseTreatment() {
    addMessage('system','Select treatment type:', ()=>{
      const g=document.createElement('div'); g.className='grid';
      [['Injectable','injectable'],['Skincare','skincare']].forEach(([lab,val])=>{
        g.appendChild(makeButton(lab, ()=>{
          state.treatment=val; addMessage('user',lab, flowA_loadServices);
        }));
      });
      addMessage('system',g.outerHTML);
    });
  }
  function flowA_loadServices() {
    addMessage('system','Loading services…');
    const Q = `
      mutation($loc:ID!){ createCart(input:{locationId:$loc}){
        cart{id availableCategories{name availableItems{id name listPrice}}}
      }}`;
    const locUrn = 'urn:blvd:Location:'+LOCATIONS[state.location];
    gql(Q,{loc:locUrn})
      .then(r=>{
        state.cartId = r.data.createCart.cart.id;
        const items = r.data.createCart.cart.availableCategories
          .flatMap(c=>c.availableItems)
          .filter(it=>{
            const n=it.name.toLowerCase();
            return state.treatment==='injectable'
              ? /(botox|filler|inject)/.test(n)
              : /(laser|microneedling|peel|hydrafacial)/.test(n);
          });
        const g=document.createElement('div'); g.className='grid';
        items.forEach(it=>{
          g.appendChild(makeButton(
            `${it.name} – $${Math.round(it.listPrice/100)}`,
            ()=>{ state.serviceId=it.id; state.serviceName=it.name;
                   addMessage('user',it.name, flowA_chooseFirstOrStaff); }
          ));
        });
        addMessage('system', g.outerHTML);
      });
  }
  function flowA_chooseFirstOrStaff() {
    addMessage('system','First available or pick staff?', ()=>{
      const g=document.createElement('div'); g.className='grid';
      [['First Available','first'],['Select Staff','staff']].forEach(([lab, val])=>{
        g.appendChild(makeButton(lab, ()=>{
          addMessage('user',lab);
          val==='first' ? flowA_reserveFirst() : flowA_pickStaff();
        }));
      });
      addMessage('system',g.outerHTML);
    });
  }
  function flowA_reserveFirst()    { flowA_completeBooking(); }
  function flowA_pickStaff() {
    addMessage('system','Select staff:', ()=>{
      const g=document.createElement('div'); g.className='grid';
      STAFF.forEach(s=>{
        g.appendChild(makeButton(s.name, ()=>{
          state.staffId=s.id; state.staffName=s.name;
          addMessage('user',s.name, ()=>flowA_completeBooking());
        }));
      });
      addMessage('system',g.outerHTML);
    });
  }
  function flowA_completeBooking() {
    // 1) add item
    const addQ = `
      mutation($cart:ID!,$item:ID!){ addCartSelectedBookableItem(input:{
        id:$cart,itemId:$item }){ cart{id} } }`;
    gql(addQ,{cart:state.cartId,item:state.serviceId})
      .then(()=>flow_reserveTime());
  }

  // —— FLOW B —— Staff → Quick Time → Treatment → Info → Booking
  function flowB_start() {
    addMessage('system','Select staff for quick booking:', ()=>{
      const g=document.createElement('div'); g.className='grid';
      STAFF.forEach(s=>{
        g.appendChild(makeButton(s.name, ()=>{
          state.staffId=s.id; state.staffName=s.name;
          addMessage('user',s.name, flowB_quickTimes);
        }));
      });
      addMessage('system',g.outerHTML);
    });
  }
  function flowB_quickTimes() {
    addMessage('system','Loading next available slots…');
    // mock three times
    const slots=[ 'Tomorrow 10:00 AM','Tomorrow 2:00 PM','Day After 9:00 AM' ];
    const g=document.createElement('div'); g.className='grid';
    slots.forEach((t,i)=>g.appendChild(makeButton(t, ()=>{
      state.timeSlot={id:'t'+i,label:t,location:state.staffName};
      addMessage('user',t, flowB_chooseTreatment);
    })));
    addMessage('system',g.outerHTML);
  }
  function flowB_chooseTreatment() {
    addMessage('system','Select treatment type:', ()=>{
      const g=document.createElement('div'); g.className='grid';
      [['Injectable','injectable'],['Skincare','skincare']].forEach(([lab,val])=>{
        g.appendChild(makeButton(lab, ()=>{
          state.treatment=val; addMessage('user',lab, flow_completeBooking);
        }));
      });
      addMessage('system',g.outerHTML);
    });
  }

  // —— FLOW C —— Staff Availability → Calendar → Date → Time → Info → Booking
  function flowC_start() {
    addMessage('system','Select staff to view full calendar:', ()=>{
      const g=document.createElement('div'); g.className='grid';
      STAFF.forEach(s=>{
        g.appendChild(makeButton(s.name, ()=>{
          state.staffId=s.id; state.staffName=s.name;
          // create a cart at first staffed location
          const loc = s.locations[0]; state.location=loc;
          const Q=`mutation($loc:ID!){createCart(input:{locationId:$loc}){cart{id}}}`;
          gql(Q,{loc:'urn:blvd:Location:'+LOCATIONS[loc]})
            .then(r=>{ state.cartId = r.data.createCart.cart.id;
                       addMessage('user',s.name, flowC_loadCalendar); });
        }));
      });
      addMessage('system',g.outerHTML);
    });
  }
  function initializeCalendar() {
    if(!currentCalendarDate){
      currentCalendarDate=new Date();
      currentCalendarDate.setDate(1);
      currentCalendarDate.setHours(0,0,0,0);
    }
  }
  function flowC_loadCalendar() {
    state.staffAvailabilityData={};
    initializeCalendar();
    renderStaffCalendar();
    loadStaffAvailabilityForMonth();
  }
  function renderStaffCalendar() {
    const container = document.getElementById('messages');
    // remove last calendar if exists
    const old = container.querySelector('.staff-calendar');
    if(old) old.remove();

    const wrap = document.createElement('div');
    wrap.className='msg system staff-calendar';
    const b = document.createElement('div'); b.className='bubble';

    // header
    const header = document.createElement('div');
    header.style.display='flex';
    header.style.justifyContent='space-between';
    header.style.marginBottom='8px';
    ['←','→'].forEach((sym,i)=>{
      const btn = document.createElement('button');
      btn.textContent = i===0?sym+' Prev Month':'Next Month '+sym;
      btn.className='button';
      btn.onclick = ()=>{
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + (i===0?-1:1));
        state.staffAvailabilityData={}; 
        renderStaffCalendar();
        loadStaffAvailabilityForMonth();
      };
      header.appendChild(btn);
    });
    const title = document.createElement('div');
    title.textContent = state.staffName + ' Availability – ' +
      currentCalendarDate.toLocaleDateString('en-US',{ month:'long',year:'numeric'});
    title.style.alignSelf='center';
    header.insertBefore(title, header.children[1]);
    b.appendChild(header);

    // day names
    const grid = document.createElement('div');
    grid.className='grid';
    grid.style.gridTemplateColumns='repeat(7,1fr)';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
      .forEach(d=>{ const dEl=document.createElement('div');
                    dEl.textContent=d;
                    dEl.style.textAlign='center';
                    grid.appendChild(dEl);
                  });

    // dates
    const year = currentCalendarDate.getFullYear();
    const month= currentCalendarDate.getMonth();
    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();
    // blanks
    for(let i=0;i<firstDay;i++){
      const cell=document.createElement('div');
      cell.style.height='60px';
      grid.appendChild(cell);
    }
    // actual days
    for(let d=1;d<=daysInMonth;d++){
      const date=new Date(year,month,d);
      const ds = date.toISOString().split('T')[0];
      const cell=document.createElement('div');
      cell.style.border='1px solid #e5e5e7';
      cell.style.borderRadius='8px';
      cell.style.padding='4px';
      cell.style.cursor='pointer';
      cell.onclick = ()=>flowC_showTimesForDate(date);
      // highlight if availability
      if(state.staffAvailabilityData[ds] &&
         state.staffAvailabilityData[ds].length>0){
        cell.style.background='#e0f7ea';
      }
      const num=document.createElement('div');
      num.textContent=d;
      num.style.fontWeight='500';
      cell.appendChild(num);
      grid.appendChild(cell);
    }
    b.appendChild(grid);

    // time-slots container
    const tsCont = document.createElement('div');
    tsCont.className='staff-times';
    tsCont.style.marginTop='12px';
    b.appendChild(tsCont);

    wrap.appendChild(b);
    container.appendChild(wrap);
    wrap.scrollIntoView({behavior:'smooth'});
  }
  function loadStaffAvailabilityForMonth(){
    const year=currentCalendarDate.getFullYear();
    const month=currentCalendarDate.getMonth();
    const days=new Date(year,month+1,0).getDate();
    const calls=[];
    for(let d=1; d<=days; d++){
      const date=new Date(year,month,d);
      if(date>=new Date()){
        calls.push(loadStaffAvailabilityForDate(date));
      }
    }
    Promise.all(calls).then(renderStaffCalendar);
  }
  function loadStaffAvailabilityForDate(date){
    const ds=date.toISOString().split('T')[0];
    const Q = `
      query($staff:ID!,$date:Date!){
        staffAvailability(staffId:$staff,searchDate:$date){
          id,startTime,location{name}
        }
      }`;
    return gql(Q,{staff:state.staffId,date:ds})
      .then(r=>{
        state.staffAvailabilityData[ds] = 
          r.data.staffAvailability.map(x=>({
            id: x.id,
            startTime: x.startTime,
            locationName: x.location.name
          }));
      }).catch(_=>{
        state.staffAvailabilityData[ds]=[];
      });
  }
  function flowC_showTimesForDate(date){
    const ds=date.toISOString().split('T')[0];
    const slots=state.staffAvailabilityData[ds]||[];
    const tsWr = document.querySelector('.staff-times');
    tsWr.innerHTML = '';
    if(!slots.length){
      tsWr.innerHTML='<em>No slots</em>'; return;
    }
    const g=document.createElement('div'); g.className='grid';
    slots.forEach(s=>{
      const tLabel = new Date(s.startTime)
        .toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
      g.appendChild(makeButton(
        tLabel + ' @ ' + s.locationName,
        ()=>{
          state.timeSlot={ id:s.id, label:tLabel, location:s.locationName };
          addMessage('user',tLabel+' @ '+s.locationName, flow_completeBooking);
        }
      ));
    });
    tsWr.appendChild(g);
  }

  // —— Shared Booking Steps ——
  function flow_reserveTime(){
    const Q = `
      mutation($cart:ID!,$time:ID!){ reserveCartBookableItems(input:{
        id:$cart, bookableTimeId:$time }){ cart{id} } }`;
    gql(Q,{cart:state.cartId,time:state.timeSlot.id})
      .then(()=>flow_collectInfo())
      .catch(()=>addMessage('system','❌ Time reservation failed.'));
  }
  function flow_collectInfo(){
    addMessage('system','Enter contact info:');
    const c=document.createElement('div');
    c.innerHTML=`
      <input id="fn" class="input" placeholder="First Name">
      <input id="ln" class="input" placeholder="Last Name">
      <input id="em" class="input" placeholder="Email">
      <input id="ph" class="input" placeholder="Phone">
      <button class="primary">Complete Booking</button>`;
    c.querySelector('button').onclick=flow_updateClient;
    addMessage('system',c.outerHTML);
  }
  function flow_updateClient(){
    state.client = {
      firstName:document.getElementById('fn').value,
      lastName: document.getElementById('ln').value,
      email:    document.getElementById('em').value,
      phone:    document.getElementById('ph').value
    };
    const Q = `
      mutation($cart:ID!,$email:Email!,$fn:String!,$ln:String!,$ph:PhoneNumber!){
        updateCart(input:{
          id:$cart,
          clientInformation:{
            email:$email, firstName:$fn, lastName:$ln, phoneNumber:$ph
          }
        }){ cart{id} } }`;
    gql(Q,{
      cart: state.cartId,
      email: state.client.email,
      fn:    state.client.firstName,
      ln:    state.client.lastName,
      ph:    state.client.phone
    }).finally(flow_completeBooking);
  }
  function flow_completeBooking(){
    const Q = `
      mutation($input:BookingCompleteInput!){
        bookingComplete(input:$input){
          booking{id}
        }
      }`;
    gql(Q,{ input:{ cartId:state.cartId } })
      .then(res=>{
        addMessage('system',
          `<strong>✅ Booking Confirmed!</strong><br>
           Provider: ${state.staffName||'Any'}<br>
           ${state.serviceName||''}<br>
           ${state.timeSlot.label}<br>
           ${state.client.firstName}, check your email shortly.`
        );
      })
      .catch(()=>addMessage('system','❌ Booking failed.'));
  }

  // —— Initialize ——
  document.addEventListener('DOMContentLoaded', start);
  </script>
</body>
</html>
